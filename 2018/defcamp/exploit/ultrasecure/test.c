#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <security/pam_appl.h>
#include <security/pam_misc.h>

/*
 * mv [.so] libultra.so
 * gcc main.c -lultra -lpam -lpam_misc -L.
 * LD_LIBRARY_PATH=`pwd` ./a.out
 */

const struct pam_conv conv = {
    misc_conv,
    NULL
};

char* base64_encode(const char* data, size_t n, size_t* nout);
int pam_sm_authenticate(pam_handle_t* pamh);

int main() {
    pam_handle_t* pamh = NULL;
    pam_start("check_user", "factorycontrol", &conv, &pamh);
    for (int i = 0; i < 10; ++i)
        pam_sm_authenticate(pamh);
    /*
    const char data[] = "\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0";
    size_t nout = 0;
    //char* b64 = base64_encode(data, sizeof(data)-1, &nout);
    char* b64 = base64_encode(data, 18, &nout);
    //printf("nout: %lu\n", sizeof(data)-1);
    printf("res:  %s\n", b64);
    printf("len:  %lu\n", strlen(b64));
    printf("nout: %lu\n", nout);
    */
    return 0;
}
